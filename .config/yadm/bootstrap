#!/bin/bash

# [bootstrap doc](https://yadm.io/docs/bootstrap)
#
# Save this file as ~/.config/yadm/bootstrap and make it executable. It will
# execute all executable files (excluding templates and editor backups) in the
# ~/.config/yadm/bootstrap.d directory when run.

set -eu

# Directory to look for bootstrap executables in
BOOTSTRAP_D="${BASH_SOURCE[0]}.d"

if [[ ! -d "$BOOTSTRAP_D" ]]; then
    echo "Error: bootstrap directory '$BOOTSTRAP_D' not found" >&2
    exit 1
fi

# 核心修改说明:
# 使用 '3< <(...)' 将 find 的输出重定向到文件描述符 3
# 使用 'read -u 3' 专门从描述符 3 读取文件名
# 这样，循环体内部的标准输入 (FD 0) 依然连接着键盘，子脚本就可以正常交互了。

while IFS= read -r -u 3 bootstrap; do
    # Filter conditions:
    # 1. Must be executable (-x)
    # 2. Must not be a yadm template file (containing "##")
    # 3. Must not be a backup file (ending with "~")
    if [[ -x "$bootstrap" && ! "$bootstrap" =~ "##" && ! "$bootstrap" =~ "~$" ]]; then
        echo "[BOOTSTRAP] Executing $bootstrap..."

        if ! "$bootstrap"; then
            echo "Error: bootstrap '$bootstrap' failed" >&2
            exit 1
        fi
    fi
done 3< <(find -L "$BOOTSTRAP_D" -type f | sort)
